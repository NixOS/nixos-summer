<section class="hero">
  <div>
    <div class="blurb">
      <h1>The Summer of Nix Blog</h1>
      <p>
        A series of blog posts detailing the experiences of the Summer of Nix participants.
      </p>
      <!--TODO programatically generate-->
      <div >
        <a class="button -primary" href="#perl-diving-with-nix">Perl Diving with Nix</a>
      </div>
    </div>
  </div>
</section>

<section class="post" id="#perlpost">
<div>
<h1 id="perl-diving-with-nix">Perl Diving with Nix</h1>
<p>This is a record of my time in the Summer of Nix holding my breath and diving into the depths of Nix to gain some Perls of wisdom.</p>
<p>Going through the issues assigned to my team I came across the the package for <a href="https://world.openfoodfacts.org/discover">OpenFoodFacts</a> a collaborative database that collects and provides open data on 1 million food products from around the world and counting!</p>
<p>Not knowing what we are eating seems like a strange thing but really how much do we know what goes into those vacuum packed bags that we open and consume daily?</p>
<p>“We are living in a world today where lemonade is made from artificial flavors and furniture polish is made from real lemons.” – Alfred E. Newman</p>
<p>OpenFoodFacts I see your <a href="https://world.openfoodfacts.org/discover">quote</a> and raise you a Newman!</p>
<p>Anyway enough preamble…</p>
<p>This project represents a deviation from the common usage of Nix to create <a href="https://nixos.org/manual/nix/unstable/expressions/derivations.html">derivations</a> that package binaries, instead its main application <a href="https://github.com/openfoodfacts/openfoodfacts-server">Product Opener</a> is a large app that requires many languages and dependencies which end up as a web service.</p>
<p>The back-end is served using Apache with the Perl Module (modules being how Apache is extended) <a href="https://en.wikipedia.org/wiki/Mod_perl">mod_perl</a> enabled, this embeds a Perl interpreter into the Apache server which handles the production of dynamic content.</p>
<p>As you can imagine there is a lot of Perl which is dynamically loaded by the Apache config file.</p>
<p>A word to the wise… there is a lot that goes into an Apache config file and the wonder of Nix is that it abstracts most of it away including the loading of the above-mentioned <a href="https://www.ibm.com/docs/en/i/7.2?topic=functionality-apache-modules">Apache modules</a>. Unless you really know what your doing it’s best to use the <code>extraConfig</code> option, which appends configuration to the Nix auto-generated one as it has many twists and turns. It is possible to override the configuration file completely with the <code>configFile</code> option, but make sure you understand the auto-generated one first.</p>
<p>To have a look for your self run <code>nix build nixpkgs#apacheHttpd &amp;&amp; cd result/conf</code>.</p>
<p>A minimal ApacheHttpd configuration in Nix:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">services.httpd</span> = {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">enablePerl</span> = true<span class="kw">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">adminAddr</span> = <span class="st">&quot;test@test.com&quot;</span><span class="kw">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">extraConfig</span> = builtins.readFile <span class="st">&quot;</span><span class="va">${src}</span><span class="st">/apache.conf&quot;</span><span class="kw">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>That <code>enablePerl</code> option is what loads up <em>mod_perl</em> for us :hands-up:</p>
<p>Slight detour into Perl: CPAN stands for <strong>Comprehensive Perl Archive Network</strong> and serves as the central repository for Perl modules. One way of defining the dependencies of a Perl project is writing plain text file called <code>cpanfile</code> that requires all the modules to be loaded from CPAN.</p>
<p>So before even looking into the code contained in the project my first step was looking at all the Perl dependencies that were cataloged in the cpanfile… of which there were 65…</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">requires</span> <span class="st">&#39;CGI&#39;</span>, <span class="st">&#39;&gt;= 4.51, &lt; 5.0&#39;</span><span class="kw">;</span> <span class="co"># libcgi-pm-perl</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">requires</span> <span class="st">&#39;Tie::IxHash&#39;</span><span class="kw">;</span> <span class="co"># libtie-ixhash-perl</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">requires</span> <span class="st">&#39;LWP::Authen::Digest&#39;</span><span class="kw">;</span> <span class="co"># libwww-perl</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">requires</span> <span class="st">&#39;LWP::Simple&#39;</span><span class="kw">;</span> <span class="co"># libwww-perl</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">etc.</span></span></code></pre></div>
<p>In the nix community there is a ever growing list of <em>2nix</em> tools that <em>translates</em> one package managers lock files into something that fits within the nix ecosystem of immutable declarative packaging. It was at this point that I started wondering if there were any tools like that for Perl.</p>
<p>The short answer is no, but there are some there is some great support for adding something from <a href="https://metacpan.org/">meta::cpan</a> (a repository containing it seems the Perl universe) to nixpkgs, in the form of the function <code>nix-generate-from-cpan</code> which is also exposed as a utility in nixpkgs.</p>
<p><code>nix run nixpkgs#nix-generate-from-cpan &lt;CPAN::MODULE&gt;</code> for the win!</p>
<p>So a few <code>nix run nixpkgs#nix-generate-from-cpan &lt;Perl::Module&gt;</code>’s later I had 40 odd shiny new Perl packages :)</p>
<p>This utility was great but perhaps the reason there isn’t a <em>2nix</em> tool for the Perl world is that it is not fool proof… in my experience it <em>just worked™</em> 70% of the time with the other 30% of the time needing minor fixes (either adding pkgs to the propagated inputs or <code>nix-generate-from-cpan</code> a Perl package that was needed as a dependency).</p>
<p>This might be an issue with the Perl ecosystem itself as a cpanfile <code>!=</code> a lock file and as the above example demonstrates it can be very vague (<code>&gt;=4.51, &lt; 5.0</code>) and vagueness is the enemy of reproducible and thus the enemy of Nix.</p>
<p>However in one case it failed drastically, and truth be told I was stuck on which way to go for a few days.</p>
<p>The intransigent bugger was (Barcode::Zbar)[https://metacpan.org/release/SPADIX/Barcode-ZBar-0.04/view/ZBar.pm] a module that provides a Perl interface to the (ZBar Barcode Reader)[https://github.com/mchehab/zbar] OpenFoodFacts has the rather excellent feature where you can just scan a bar code as a discovery mechanism.</p>
<p>The aforementioned <code>nix-generate-from-cpan</code> kindly provided</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">BarcodeZBar</span> = buildPerlPackage {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">pname</span> = <span class="st">&quot;Barcode-ZBar&quot;</span><span class="kw">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">version</span> = <span class="st">&quot;0.04&quot;</span><span class="kw">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">src</span> = fetchurl {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      <span class="ex">url</span> = <span class="st">&quot;mirror://cpan/authors/id/S/SP/SPADIX/Barcode-ZBar-0.04.tar.gz&quot;</span><span class="kw">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="ex">sha256</span> = <span class="st">&quot;d57e1ad471b6a29fa4134650e6eec9eb834d42cbe8bf8f0608c67d6dd0f8f431&quot;</span><span class="kw">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="kw">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">meta</span> = {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="kw">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>Hmmm rather bare, didn’t even include the Zbar binary as part of its <code>propagatedBuildInputs</code>.</p>
<p><strong>SideNote</strong>: <code>propagatedBuildInputs</code> here meaning anything that is a runtime dependency whereas <code>buildInputs</code> are for dependencies that are exclusively build-time dependencies (eg. Tests and make file generators) - <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-perl-packaging">Perl Packaging in Nix</a></p>
<p>After fixing the inputs it was time to give it a try.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">buildInputs</span> = [ TestMore ExtUtilsMakeMaker ]<span class="kw">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">propagatedBuildInputs</span> = [ zbar PerlMagick ]<span class="kw">;</span></span></code></pre></div>
<p>Where upon it failed with the message:</p>
<pre><code>perl5.34.0-Barcode-ZBar&gt; ZBar.xs: In function &#39;XS_Barcode__ZBar_version&#39;:
perl5.34.0-Barcode-ZBar&gt; ZBar.xs:202:9: error: too few arguments to function &#39;zbar_version&#39;</code></pre>
<p>Hmmmm on investigation it seems this module was last updated in 2009 and since then the <code>zbar</code> project has been forked and continued developing. The ZBar project now uses semver versioning while the module is stuck in the past with <code>major.minor</code> versioning.</p>
<p>Nixpkgs topping repology’s list for <a href="https://repology.org/repositories/statistics/newest">Projects up to date</a> obviously meant that it wasn’t slouching when it came to zbar and had zoomed ahead of the Perl module to version <code>0.23.90</code> (it was never clear what version the module was expecting but 2009 put it at either <code>0.9</code> or <code>0.10</code>).</p>
<p>It appeared to me that I had two options 1. Naively patch this function so it takes 3 arguments in the Perl module and hope that works. 2. More realistically create an overlay for zbar for a version that was compatible with the Perl Module.</p>
<h2 id="option-1---the-patch">Option 1 - The Patch</h2>
<p>Summer of Nix is all about learning so I figured it was worth a shot and after a quick watch of the excellent <a href="https://www.youtube.com/watch?v=5K_2RSjbdXc">How to create a patch for any package</a> by Jon Ringer (go check it out) and a quick fiddle in git I had a patch file.</p>
<pre><code>From e51b51a77eab1251babc58929a4d2107172a041f Mon Sep 17 00:00:00 2001
From: Thomas Sean Dominic Kelly &lt;thomassdk@pm.me&gt;
Date: Fri, 6 Aug 2021 12:35:06 +0100
Subject: [PATCH] version patch

---
 ZBar.xs | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/ZBar.xs b/ZBar.xs
index ad6fc56..97bd2c0 100644
--- a/ZBar.xs
+++ b/ZBar.xs
@@ -198,9 +198,10 @@ zbar_version()
     PREINIT:
    unsigned major;
         unsigned minor;
+        unsigned patch;
     CODE:
-        zbar_version(&amp;major, &amp;minor);
-        RETVAL = newSVpvf(&quot;%u.%u&quot;, major, minor);
+        zbar_version(&amp;major, &amp;minor, &amp;patch);
+        RETVAL = newSVpvf(&quot;%u.%u.%u&quot;, major, minor, patch);
     OUTPUT:
         RETVAL
 
-- 
2.32.0</code></pre>
<p>Applying patches in nix is the simplest thing in the world just add it to the <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-patch-phase">patch phase</a> and your golden. The manual is a bit sparse in this regard so the code looks something like.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">patchPhase</span> = [ ./version.patch ]<span class="kw">;</span></span></code></pre></div>
<p>This is possible as <code>buildPerlPackage</code> is built on top of <a href="https://nixos.org/manual/nixpkgs/stable/#idm140737320528768"><code>stdenv</code></a> allowing us to customise everything in the usual Nixy way.</p>
<p>Aha something is happening it seems to successfully compile but fails the tests.</p>
<p>The full logs are below but TLDR the salient line seems to be:</p>
<pre><code>#Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.</code></pre>
<p>Ooof undefined symbol OK so the module is looking for a symbol and not finding it in the zbar shared object.</p>
<p>There goes my naivety.</p>
<h4 id="logs">Logs</h4>
<details>
<summary>
Click to see full logs
</summary>
<pre><code>this derivation will be built:
  /nix/store/gww59146rs399rjc3fnawrjng4pqf6dl-perl5.32.1-Barcode-ZBar-0.04.drv
building &#39;/nix/store/gww59146rs399rjc3fnawrjng4pqf6dl-perl5.32.1-Barcode-ZBar-0.04.drv&#39;...
unpacking sources
unpacking source archive /nix/store/g5kazmm00923w6rgcf5h6rzrlp7b1nhj-Barcode-ZBar-0.04.tar.gz
source root is Barcode-ZBar-0.04
setting SOURCE_DATE_EPOCH to timestamp 1256327204 of file Barcode-ZBar-0.04/META.yml
patching sources
applying patch /nix/store/3ix6dz6lmifqrmbs24jbjh9z07wbscbi-0001-version-patch.patch
patching file ZBar.xs
configuring
patching ./examples/processor.pl...
patching ./examples/scan_image.pl...
patching ./examples/read_one.pl...
patching ./examples/paginate.pl...
Checking if your kit is complete...
Looks good
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 162.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 166.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 171.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 173.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 181.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 183.
Use of uninitialized value $thispth in concatenation (.) or string at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/Liblist/Kid.pm line 187.
Warning (mostly harmless): No library found for -lzbar
Generating a Unix-style Makefile
Writing Makefile for Barcode::ZBar
Invalid LICENSE value &#39;lgpl&#39; ignored
Writing MYMETA.yml and MYMETA.json
no configure script, doing nothing
building
build flags: SHELL=/nix/store/xvvgw9sb8wk6d2c0j3ybn7sll67s3s4z-bash-4.4-p23/bin/bash
cp ZBar.pm blib/lib/Barcode/ZBar.pm
cp ZBar/Processor.pod blib/lib/Barcode/ZBar/Processor.pod
cp ZBar/ImageScanner.pod blib/lib/Barcode/ZBar/ImageScanner.pod
cp ZBar/Image.pod blib/lib/Barcode/ZBar/Image.pod
cp ZBar/Symbol.pod blib/lib/Barcode/ZBar/Symbol.pod
Running Mkbootstrap for ZBar ()
chmod 644 &quot;ZBar.bs&quot;
&quot;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/bin/perl&quot; -MExtUtils::Command::MM -e &#39;cp_nonempty&#39; -- ZBar.bs blib/arch/auto/Barcode/ZBar/ZBar.bs 644
&quot;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/bin/perl&quot; &quot;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/xsubpp&quot;  -typemap &#39;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/ExtUtils/typemap&#39; -typemap &#39;/build/Barcode-ZBar-0.04/typemap&#39;  ZBar.xs &gt; ZBar.xsc
mv ZBar.xsc ZBar.c
cc -c   -D_REENTRANT -D_GNU_SOURCE -fwrapv -fno-strict-aliasing -pipe -fstack-protector-strong -I/no-such-path/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -O2   -DVERSION=\&quot;0.04\&quot; -DXS_VERSION=\&quot;0.04\&quot; -fPIC &quot;-I/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/CORE&quot;   ZBar.c
rm -f blib/arch/auto/Barcode/ZBar/ZBar.so
cc  -shared -O2 -L/nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib -fstack-protector-strong  ZBar.o  -o blib/arch/auto/Barcode/ZBar/ZBar.so  \
      \

chmod 755 blib/arch/auto/Barcode/ZBar/ZBar.so
Manifying 5 pod documents
running tests
check flags: SHELL=/nix/store/xvvgw9sb8wk6d2c0j3ybn7sll67s3s4z-bash-4.4-p23/bin/bash VERBOSE=y test
&quot;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/bin/perl&quot; -MExtUtils::Command::MM -e &#39;cp_nonempty&#39; -- ZBar.bs blib/arch/auto/Barcode/ZBar/ZBar.bs 644
PERL_DL_NONLAZY=1 &quot;/nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/bin/perl&quot; &quot;-MExtUtils::Command::MM&quot; &quot;-MTest::Harness&quot; &quot;-e&quot; &quot;undef *Test::Harness::Switches; test_harness(0, &#39;blib/lib&#39;, &#39;blib/arch&#39;)&quot; t/*.t
t/Decoder.t ....... 1/13
#   Failed test &#39;use Barcode::ZBar;&#39;
#   at t/Decoder.t line 10.
#     Tried to use &#39;Barcode::ZBar&#39;.
#     Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.
#  at t/Decoder.t line 10.
# Compilation failed in require at t/Decoder.t line 10.
# BEGIN failed--compilation aborted at t/Decoder.t line 10.
Bareword &quot;Barcode::ZBar::Symbol::PARTIAL&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 48.
Bareword &quot;Barcode::ZBar::Symbol::NONE&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 27.
Bareword &quot;Barcode::ZBar::SPACE&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 57.
Bareword &quot;Barcode::ZBar::Symbol::QRCODE&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 61.
Bareword &quot;Barcode::ZBar::Config::ENABLE&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 61.
Bareword &quot;Barcode::ZBar::Symbol::PARTIAL&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 69.
Bareword &quot;Barcode::ZBar::Symbol::NONE&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 69.
Bareword &quot;Barcode::ZBar::Symbol::EAN13&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 73.
Bareword &quot;Barcode::ZBar::BAR&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 81.
Bareword &quot;Barcode::ZBar::Symbol::EAN13&quot; not allowed while &quot;strict subs&quot; in use at t/Decoder.t line 85.
Execution of t/Decoder.t aborted due to compilation errors.
# Looks like your test exited with 255 just after 1.
t/Decoder.t ....... Dubious, test returned 255 (wstat 65280, 0xff00)
Failed 13/13 subtests
t/Image.t ......... 1/22
#   Failed test &#39;use Barcode::ZBar;&#39;
#   at t/Image.t line 10.
#     Tried to use &#39;Barcode::ZBar&#39;.
#     Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.
#  at t/Image.t line 10.
# Compilation failed in require at t/Image.t line 10.
# BEGIN failed--compilation aborted at t/Image.t line 10.
Bareword &quot;Barcode::ZBar::Symbol::EAN13&quot; not allowed while &quot;strict subs&quot; in use at t/Image.t line 101.
Execution of t/Image.t aborted due to compilation errors.
# Looks like your test exited with 255 just after 1.
t/Image.t ......... Dubious, test returned 255 (wstat 65280, 0xff00)
Failed 22/22 subtests
t/pod-coverage.t .. skipped: Test::Pod::Coverage required for testing pod coverage
t/pod.t ........... skipped: Test::Pod 1.00 required for testing POD
t/Processor.t ..... 1/20
#   Failed test &#39;use Barcode::ZBar;&#39;
#   at t/Processor.t line 10.
#     Tried to use &#39;Barcode::ZBar&#39;.
#     Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.
#  at t/Processor.t line 10.
# Compilation failed in require at t/Processor.t line 10.
# BEGIN failed--compilation aborted at t/Processor.t line 10.
Bareword &quot;Barcode::ZBar::Symbol::EAN13&quot; not allowed while &quot;strict subs&quot; in use at t/Processor.t line 58.
Execution of t/Processor.t aborted due to compilation errors.
# Looks like your test exited with 255 just after 1.
t/Processor.t ..... Dubious, test returned 255 (wstat 65280, 0xff00)
Failed 20/20 subtests
t/Scanner.t ....... 1/3
#   Failed test &#39;use Barcode::ZBar;&#39;
#   at t/Scanner.t line 10.
#     Tried to use &#39;Barcode::ZBar&#39;.
#     Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.
#  at t/Scanner.t line 10.
# Compilation failed in require at t/Scanner.t line 10.
# BEGIN failed--compilation aborted at t/Scanner.t line 10.
Can&#39;t locate object method &quot;new&quot; via package &quot;Barcode::ZBar::Scanner&quot; (perhaps you forgot to load &quot;Barcode::ZBar::Scanner&quot;?) at t/Scanner.t line 14.
# Looks like your test exited with 255 just after 1.
t/Scanner.t ....... Dubious, test returned 255 (wstat 65280, 0xff00)
Failed 3/3 subtests
t/ZBar.t .......... 1/3
#   Failed test &#39;use Barcode::ZBar;&#39;
#   at t/ZBar.t line 10.
#     Tried to use &#39;Barcode::ZBar&#39;.
#     Error:  Can&#39;t load &#39;/build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so&#39; for module Barcode::ZBar: /build/Barcode-ZBar-0.04/blib/arch/auto/Barcode/ZBar/ZBar.so: undefined symbol: zbar_scanner_reset at /nix/store/n7hbdyp3bsmdxy2lcxivaxnq4nv8ndv3-perl-5.32.1/lib/perl5/5.32.1/x86_64-linux-thread-multi/DynaLoader.pm line 193.
#  at t/ZBar.t line 10.
# Compilation failed in require at t/ZBar.t line 10.
# BEGIN failed--compilation aborted at t/ZBar.t line 10.
Undefined subroutine &amp;Barcode::ZBar::version called at t/ZBar.t line 14.
# Looks like your test exited with 255 just after 1.
t/ZBar.t .......... Dubious, test returned 255 (wstat 65280, 0xff00)
Failed 3/3 subtests

Test Summary Report
-------------------
t/Decoder.t     (Wstat: 65280 Tests: 1 Failed: 1)
  Failed test:  1
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 13 tests but ran 1.
t/Image.t       (Wstat: 65280 Tests: 1 Failed: 1)
  Failed test:  1
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 22 tests but ran 1.
t/Processor.t   (Wstat: 65280 Tests: 1 Failed: 1)
  Failed test:  1
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 20 tests but ran 1.
t/Scanner.t     (Wstat: 65280 Tests: 1 Failed: 1)
  Failed test:  1
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 3 tests but ran 1.
t/ZBar.t        (Wstat: 65280 Tests: 1 Failed: 1)
  Failed test:  1
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 3 tests but ran 1.
Files=7, Tests=5,  0 wallclock secs ( 0.02 usr  0.00 sys +  0.20 cusr  0.03 csys =  0.25 CPU)
Result: FAIL
Failed 5/7 test programs. 5/5 subtests failed.
make: *** [Makefile:1040: test_dynamic] Error 255
error: builder for &#39;/nix/store/gww59146rs399rjc3fnawrjng4pqf6dl-perl5.32.1-Barcode-ZBar-0.04.drv&#39; failed with exit code 2;
       last 10 log lines:
       &gt;   Non-zero exit status: 255
       &gt;   Parse errors: Bad plan.  You planned 3 tests but ran 1.
       &gt; t/ZBar.t        (Wstat: 65280 Tests: 1 Failed: 1)
       &gt;   Failed test:  1
       &gt;   Non-zero exit status: 255
       &gt;   Parse errors: Bad plan.  You planned 3 tests but ran 1.
       &gt; Files=7, Tests=5,  0 wallclock secs ( 0.02 usr  0.00 sys +  0.20 cusr  0.03 csys =  0.25 CPU)
       &gt; Result: FAIL
       &gt; Failed 5/7 test programs. 5/5 subtests failed.
       &gt; make: *** [Makefile:1040: test_dynamic] Error 255
       For full logs, run &#39;nix log /nix/store/gww59146rs399rjc3fnawrjng4pqf6dl-perl5.32.1-Barcode-ZBar-0.04.drv&#39;.</code></pre>
</details>
<h2 id="option-2-the-overlay">Option 2: The Overlay</h2>
<p>Naive approach 2 lets just overlay the source code with <code>0.10</code> (a version from 2009)[https://github.com/mchehab/zbar/releases/tag/0.10]…</p>
<p>This wasn’t very successful as it seems the steps to build ZBar has <a href="https://github.com/NixOS/nixpkgs/commit/57ffe86efa988788b6c58a1e3b682ee8f80c74a3#diff-2793faccce1027ffbb3d7e8658912e32422bdb8907db45e295f97c2768c526c2">changed significantly</a> between versions.</p>
<p>However I chose 0.10 not only for the fact that it was from 2009 but also this was the (oldest version)[https://github.com/NixOS/nixpkgs/blob/7147ef8e80ae9f5d7f13b0c29bbf7a4d27982d3d/pkgs/tools/graphics/zbar/default.nix] in nixpkgs.</p>
<p>So lets substitute the current package with an this old one.</p>
<p>A handy tool I found along the way was (Nix package versions)[https://lazamar.co.uk/nix-versions/] which gives a nice web interface for finding older versions of packages and giving you the revision that they were in.</p>
<p>Armed with a really hacky zbar overlay lets try this again.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zbar</span> = final: prev: {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="ex">zbar</span> = <span class="er">(</span><span class="ex">import</span> <span class="er">(</span><span class="ex">builtins.fetchGit</span> {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>       <span class="ex">url</span> = <span class="st">&quot;https://github.com/NixOS/nixpkgs/&quot;</span><span class="kw">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>       <span class="ex">ref</span> = <span class="st">&quot;refs/heads/nixpkgs-unstable&quot;</span><span class="kw">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">rev</span> = <span class="st">&quot;12408341763b8f2f0f0a88001d9650313f6371d5&quot;</span><span class="kw">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>       <span class="er">}</span><span class="kw">)</span> <span class="kw">{</span> <span class="ex">system</span> = <span class="st">&quot;x86_64-linux&quot;</span><span class="kw">;</span> <span class="ex">}</span><span class="er">)</span><span class="ex">.zbar</span><span class="kw">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">};</span></span></code></pre></div>
<p>Sidenote: A more nixy way of doing this would be to import this ancient version of nixpkgs as an input into your flake:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">inputs.nixpkgs-ancient</span> = {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">url</span> = <span class="st">&quot;github:NixOS/nixpkgs?rev=12408341763b8f2f0f0a88001d9650313f6371d5&quot;</span><span class="kw">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">flake</span> = false<span class="kw">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>and then use it via:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">zbar</span> = final.callPackage ./zbar.nix { pkgs = final<span class="kw">;</span> <span class="ex">pkgsAncient</span> = import nixpkgs-ancient { system = final.system<span class="kw">;</span> <span class="er">}</span><span class="kw">;</span> <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>where <code>zbar.nix</code> is:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span> <span class="ex">pkgs,</span> pkgsAncient }:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span> <span class="va">zbar</span> <span class="op">=</span> <span class="va">pkgsAncient</span>.zbar<span class="kw">;</span> <span class="er">in</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">with</span> pkgs<span class="kw">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">with</span> perlPackages<span class="kw">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">buildPerlPackage</span> {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pname</span> = <span class="st">&quot;Barcode-ZBar&quot;</span><span class="kw">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">version</span> = <span class="st">&quot;0.04&quot;</span><span class="kw">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">src</span> = fetchurl {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">url</span> = <span class="st">&quot;mirror://cpan/authors/id/S/SP/SPADIX/Barcode-ZBar-0.04.tar.gz&quot;</span><span class="kw">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">sha256</span> = <span class="st">&quot;d57e1ad471b6a29fa4134650e6eec9eb834d42cbe8bf8f0608c67d6dd0f8f431&quot;</span><span class="kw">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">};</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">doCheck</span> = true<span class="kw">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">buildInputs</span> = [ pkg-config TestMore ExtUtilsMakeMaker TestHarness ]<span class="kw">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">propagatedBuildInputs</span> = [ zbar PerlMagick ]<span class="kw">;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">meta</span> = {</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">homepage</span> = <span class="st">&quot;https://github.com/mchehab/zbar&quot;</span><span class="kw">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">description</span> = <span class="st">&quot;Perl interface to the ZBar Barcode Reader&quot;</span><span class="kw">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">license</span> = with lib.licenses<span class="kw">;</span> <span class="bu">[</span> gpl2Plus <span class="bu">]</span><span class="kw">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>Thanks to <a href="https://las.rs">Las</a> for this flakier way of doing things.</p>
<p>Sadly this still fails with the <code>undefined symbol</code> error so it seems we need an ever more ancient version of Zbar</p>
<h3 id="where-things-float">Where things float</h3>
<p>It seems that we have reached the point of diminishing returns and that it does not seem worth while to figure out how to build ever older versions of ZBar in the hope that this <em>might</em> someday work.</p>
<p>So what next?</p>
<p>Perhaps we can convince upstream to take on the maintenance of this Perl module and bring it (and their own project) kicking and screaming into the decade of the ’20s.</p>
<h2 id="sometimes-your-brain-just-needs-some-downtime"><a href="https://www.scientificamerican.com/article/mental-downtime/">Sometimes your brain just needs some downtime</a></h2>
<p>A few days after putting this project on the back burner I woke up with an inexplicable renewed enthusiasm for tackling this issue.</p>
<p>Looking back through all the resources I noticed that the maintained version of <code>ZBar</code> has a series of folders named after various programming languages and platforms, including <em>Perl</em>.</p>
<p>Interesting…</p>
<p>It seems that when forking ZBar mchehab, the new maintainer, also made the sage decision to include all the myriad interfaces for the library and maintain them!</p>
<p>Armed with this new Perl module that we <strong>knew</strong> worked with the latest ZBar library it was possible to construct a new <code>buildPerlPackage</code> that reused the src from the ZBar packaged in nixpkgs.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">BarcodeZBar</span> = buildPerlPackage {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pname</span> = <span class="st">&quot;Barcode-ZBar&quot;</span><span class="kw">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">version</span> = <span class="st">&quot;0.04&quot;</span><span class="kw">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">src</span> = <span class="st">&quot;</span><span class="va">${zbar</span><span class="er">.src</span><span class="va">}</span><span class="st">/perl&quot;</span><span class="kw">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">postPatch</span> = <span class="st">&#39;&#39;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">substituteInPlace</span> Makefile.PL <span class="at">--replace</span> <span class="st">&quot;-lzbar&quot;</span> <span class="st">&quot;-L</span><span class="va">${zbar</span><span class="er">.lib</span><span class="va">}</span><span class="st">/lib -lzbar&quot;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This test requires network access</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span> t/Processor.t</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;&#39;</span><span class="kw">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">doCheck</span> = true<span class="kw">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">buildInputs</span> = [ TestPodCoverage TestPod DevelChecklib TestMore ExtUtilsMakeMaker ]<span class="kw">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">propagatedBuildInputs</span> = [ zbar PerlMagick ]<span class="kw">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">meta</span> = {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">homepage</span> = <span class="st">&quot;https://github.com/mchehab/zbar/tree/master/perl&quot;</span><span class="kw">;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">description</span> = <span class="st">&quot;Perl interface to the ZBar Barcode Reader&quot;</span><span class="kw">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">license</span> = with lib.licenses<span class="kw">;</span> <span class="bu">[</span> gpl2Plus <span class="bu">]</span><span class="kw">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>Et Voila we have a Perl Module that interfaces with the current version of ZBar!</p>
<h3 id="addendum">Addendum</h3>
<p>The keen-eyed among you will have noticed that there is a bit of trickery happening with the <code>postPatch</code> hook.</p>
<p>Perl has the incredibly unhelpful error command:</p>
<p><code>Warning (mostly harmless): No library found for -lzbar</code></p>
<p>As you can imagine this is unquestionably harmful and causes the tests, and of lesser importance the final output 😛, to fail.</p>
<p>This happens because for some reason our propagatedBuildInputs not being added to the sandbox for the Makefile through the use of <code>propagatedBuildInputs</code> (which adds paths to <code>NIX_LDFLAGS</code>). Instead these had to be added manually by linking them directly in the Makefile.</p>
<p>It is unclear to me why this is and perhaps a issue needs to be opened that addresses this.</p>
<h4 id="a-quick-refresher-on-nix_ldflags.">A quick refresher on <code>NIX_LDFLAGS</code>.</h4>
<p>Nix differs drastically from other Linux distributions (and in difference is strength) and does not store header files and libraries in the traditional <code>/usr/include</code> where the compiler expects them, instead everything is in the Nix Store… Which means that somehow we need to make the compiler aware of the correct paths to these headers and libraries. This is where <code>NIX_LDFLAGS</code> (and its partner in compile <code>NIX_CFLAGS_COMPILE</code>) come in. The ALL CAPS should give you a clue that they are <em>environment variables</em> which are used to furnish the compiler (by way of command line arguments) with these correct paths. This is all done using shell-scripts that wrap around the actual compiler, for more information see the <a href="https://nixos.wiki/wiki/C">C section</a> on the Nixos Wiki.</p>
</div>
</section>
